<element name="type-ahead" attributes="query suggestion">
	<template>
		<style>
		  .container {
			position: relative;
			width: 400px;
			margin: 0 auto;
			margin-top: 40px;
		  }
		  .container input {
			position: absolute;
			top: 0px; left: 0px;
			width: 400px;
			height: 40px;
			border-radius: 3px;
			font-size: 13pt;
			padding: 0px 10px;
		  }
		  .container input#top {
			border: 1px solid transparent;
			background-color: transparent;
		  }
		  .container input#bottom {
			border: 1px solid #aaa;
			color: #888;
			box-shadow: 0px 1px 1px #ddd;
		  }
		</style>
		<div class="container">
		  <input type="text" id="bottom" value="{{suggestion}}"/>
		  <input type="text" id="top" value="{{query}}"/>
		</div>
	</template>
	<script>
		Polymer.register(this);
	</script>
</element>

<element name="typeahead-model" attributes="data query suggestion">
	<script>
		Polymer.register(this,{
			queryChanged: function(){
				this.suggestion = this.query;
				
				var words = this.query.split(" "); 
				var lastWord = words.pop();
				var base = this.suggestion.slice(0,this.suggestion.length - lastWord.length);
				
				var rgx = new RegExp("[^A-z0-9]("+lastWord+"[A-z0-9]*)","i");
				for(id in this.data){
					var oNote = this.data[id];
					var matches = rgx.exec(oNote.note);
					if(matches != null && matches.length > 0){
						this.suggestion = base + matches[1];
					}
				}
				
				//this.output.sort(function(a,b){return a.queryRank < b.queryRank});
			}
		});
	</script>
</element>

<element name="relations-model" attributes="data query output excludes">
	<script>
		Polymer.register(this,{
			queryChanged: function(){
				this.output = [];
				
				var words = this.query.split(" "); words.pop();
				var query = "";
				for(var id in words){
					var ct = false;
					for(var exid in this.excludes){
						if(this.excludes[exid] == words[id].toLowerCase()){
							ct = true;
							break;
						}
					}
					if(ct)continue;
					if(query!=="")query+="|";
					query += words[id]+"[^a-zA-Z0-9]+";
				}
				if(words.length<1 || query=="")return;
				var rgx = new RegExp("("+query+")","ig");
				
				for(id in this.data){
					var oNote = this.data[id];
					var matches = (oNote.note+" ").match(rgx);
					if(matches != null && matches.length > 0){
						oNote["queryRank"] = oNote.rank * matches.length;
						oNote["found"] = oNote.note.replace(rgx,"<b>\$1</b>");
						this.output.push(oNote);
					}
				}
				
				this.output.sort(function(a,b){return a.queryRank < b.queryRank});
			}
		});
	</script>
</element>