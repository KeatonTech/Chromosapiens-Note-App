{% extends 'application.html' %}
{% block content %}
    <link rel="stylesheet" href="bunny-editor.css"/>
    <div class="row">
        <aside class="span3 hidden-phone" id="sidebar">
            <br>
            [Top bunnies here...]
            {#        <h3>Online Users</h3>#}
            {#        <ul>#}
            {#            <li>User 1</li>#}
            {#            <li>User 2</li>#}
            {#        </ul>#}
            {#        <h3>Documents</h3>#}
            {#        <ul>#}
            {#        {% for document in documents %}#}
            {#        <li>{{ document.title }}</li>#}
            {#        {% endfor %}#}
            {#        <li><a href="#newNotebook" role="button" data-toggle="modal">Add New Document</a></li>#}
            {#        </ul>#}
            <!-- Modal -->
            {#            <div id="newNotebook" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"#}
            {#                 aria-hidden="true">#}
            {#                <div class="modal-header">#}
            {#                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>#}
            {#                    <h3 id="myModalLabel">New Document</h3>#}
            {#                </div>#}
            {#                <form action="/documents/add" method="post">#}
            {#                    <div class="modal-body">#}
            {#                        <div class="input-append">#}
            {#                            <input id="appendedInputButtons" type="text" name="document-title"#}
            {#                                   id="document-title" placeholder="Document name">#}
            {#                            <input type="hidden" id="notebook-id" name="notebook-id" value="{{ notebook_id }}">#}
            {#                            <input type="hidden" id="lecture_id" name="lecture_id" value="{{ lecture_id }}">#}
            {#                            <button class="btn" type="submit">Add</button>#}
            {#                        </div>#}
            {#                    </div>#}
            {#                </form>#}
            {#            </div>#}
        </aside>

        <section class="span9" id="main">
            <div class="row-fluid">
                <div id="content" class="span12">
                    <h3>Lecture: {{ lecture_id }}</h3>
                    <p><em>[insert num] participants online</em></p>

                    <ul id="myBunnies" class="bunnyList"></ul>
                </div>
                
                <button class="btn-block btn btn-large" onclick="edit.newBunny()">Add New Element</button>
                <ul id="otherBunnies" class="row bunnyList"></ul>
                <bunny-list></bunny-list>
            </div>
        </section>
    </div>
    <!-- Scripts here. Don't remove this ↓ -->
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script src="/bunny-editor.js"></script>
    <script src="/bunny-auto.js"></script>
    <script>
        window.identifiers = {
            document: {{document_id}},
            lecture: "{{lecture_id}}"
        };
        console.log(identifiers);
    </script>
    <script type="application/javascript">
        var channel = new goog.appengine.Channel('{{streamToken}}');
        var bunnies = {}; var users = {};
        var edit;

        $(window).unload(function () {
            $.ajax({
                type: 'POST',
                url: '/api/disconnect',
                async: false,
                data: {stream_token: "{{streamToken}}"}
            });
        });

        var ts = new Date().getTime();
        var myCreator = '{{user_id}}';
        $.getJSON("/api/getbunnies?document_id=" + identifiers.document, function (data) {
            console.log(data);
            var count = 0;
            for (each in data) {
                var bunny = {
                    id: each,
                    body: data[each].note,
                    head: data[each].title
                };
                bunnies[each] = bunny;
            }
            console.log(window.bunnies);

            $(function () {
                edit = new editor(bunnies, "#myBunnies", "#otherBunnies", myCreator);
                edit.start();
                
                var streamToken = '{{streamToken}}';
                var socket = channel.open();
                socket.onopen = function () {
                    console.log("Connection opened");
                };
                socket.onmessage = function (message) {
                    if(!("cmd" in message))return;
                    switch(message.cmd){
                        case "updateBunny":
                            if(!message.payload.id in bunnies)break;
                            bunnies[message.payload.id] = message.payload;
                            edit.update(message.payload);
                            break;
                        case "newBunny":
                            bunnies[message.payload.id] = message.payload;
                            break;
                        case "removeBunny":
                            bunnies[message.id] = null;
                            edit.deleteBunnyByID(message.id);
                            break;
                            
                        case "newUser":
                            users[message.payload.id] = message.payload;
                            break;
                        case "removeUser":
                            users[message.id] = null;
                            break;
                    }
                };
            });
        });

        $("body").on("edited", ".bunny", function (e) {
            console.log("Edited");
            var bunnyData = edit.dataFromDOMBunny(this);
            $.post('/api/update_bunny?title=' + bunnyData.head + '&note=' + bunnyData.body + '&bunny_id=' + bunnyData.id, function (data) {
                console.log("EDITTED");
            });
        });

        $("body").on("created", ".bunny", function (e, obj) {
            console.log("Created");
            var bunnyData = edit.dataFromDOMBunny(obj);
            $.post('/api/add_bunny?title=' + bunnyData.head + '&note=' + bunnyData.body + '&bunny_id=' + bunnyData.id + '&document_id=' + identifiers.document + '&lecture_id=' + identifiers.lecture, function (data) {
                console.log("EDITTED");
            });
        });

        // PUBLISHED EVENTS
        //   edited: Runs when the content of a bunny changes
        //    added: Runs when a new bunny is added to either list
        //  created: Runs when a new bunny is created in either list
        //  removed: Runs when a bunny is deleted
        //   pulled: Runs when another user's bunny is dragged in
    </script>


{% endblock %}
