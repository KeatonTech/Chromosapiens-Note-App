{% extends 'application.html' %}
{% block content %}
    <link rel="stylesheet" href="bunny-editor.css"/>
    <div class="row">
        <aside class="span4 hidden-phone">
            <div class="text-center visible-desktop">
                <a id="logo" href="/dashboard">
                    <h1>
                        <div id="brand">
                            Notorious
                            <h4>Hop on your notes.</h4>
                        </div>
                        <div id="bunny">
                            {% include 'Bunny.svg' %}
                        </div>
                    </h1>

                </a>
            </div>
            <div class="text-center hidden-desktop">
                <h3><a id="logo" href="/dashboard"><img id="mobile-bunny" src="Bunny_4.png">Notorious
                    <h5 id="mobile-tag">Hop on your notes.</h5></a></h3>

            </div>
            <div class="accordion" id="accordion2">
                {% if tutorial == "yes" %}
                <div class="accordion-group">
                    <div class="accordion-heading">
                            <a href="/rmtutorial" type="button" class="close" style="float:right; position: relative; top: 10px; right: 10px">×</a>
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2"
                           href="#collapseStart">
                            <h3>Get Started </h3>
                        </a>
                    </div>
                    <div id="collapseStart" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <h4>Note-Taking 2.0</h4>
                            <p> 
                                Notorious is an app that allows a group to collaborate to take notes together
                                within a lecture. You can join or create a lecture by creating a new lecture notebook or 
                                entering a Lecture Code in the sidebar.</p>
                            <h4>Collaboration</h4>    
                            <p> 
                                Once in a Lecture, you can open your Lecture Notebook and instantly begin 
                                taking notes. As you type, you will see notes similar to yours that 
                                others have typed, and you can attach them to your own notes.</p>
                            <h4>Organization</h4>
                            <p>
                                When your group is done, your document will be saved in a notebook 
                                created specifically for your lecture, and it will show up on your Dashboard for 
                                you to revisit.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2"
                           href="#collapseOne">
                            <h3>Notebooks</h3>
                        </a>
                    </div>
                    <div id="collapseOne" class="accordion-body collapse">
                        <div class="accordion-inner">
                            <h4>Lecture Notebooks:</h4>
                            {% if notebooks|length == 0 %}
                                Get started by adding a notebook to the right.
                            {% endif %}
                            <ul class="hidden-phone">
                                {% for notebook in notebooks %}
                                    <div id="color-master">
                                        <a href="notebooks/?lecture_id={{ notebook.lecture_id }}" class="notebooks"
                                           style="color: #{{ notebook.color }};">{{ notebook.title }}</a> <a
                                            href="/notebooks/rm?notebook-id={{ notebook.key.id()}}">
                                        <small>[delete]</small>
                                    </a><br>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=1">
                                            <div class="color-box" style="background-color:#00BBA2;"></div>
                                        </a>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=2">
                                            <div class="color-box" style="background-color:#F9574A;"></div>
                                        </a>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=3">
                                            <div class="color-box" style="background-color:#A4E661;"></div>
                                        </a><br>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=4">
                                            <div class="color-box" style="background-color:#FFBF53;"></div>
                                        </a>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=5">
                                            <div class="color-box" style="background-color:#86C6FF;"></div>
                                        </a>
                                        <a href="/notebooks/color?notebook_id={{ notebook.key.id()}}&color=6">
                                            <div class="color-box" style="background-color:#D8D8D8;"></div>
                                        </a>
                                    </div>
                                    <br>
                                {% endfor %}
                            </ul>
                            <ul class="visible-phone">
                                {% for notebook in notebooks %}
                                        <a href="notebooks/?lecture_id={{ notebook.lecture_id }}" class="notebooks">{{ notebook.title }}</a> <a
                                            href="/notebooks/rm?notebook-id={{ notebook.key.id()}}"><small>[delete]</small></a>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2"
                           href="#collapseTwo">
                            <h3>Lectures</h3>
                        </a>
                    </div>
                    <div id="collapseTwo" class="accordion-body collapse">
                        <div class="accordion-inner">
                            <h4>Recent Lectures</h4>
                            {% include 'lecture.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <section class="span8" id="main">
            <div class="row-fluid">
                <div id="content" class="span12">
                    <h3>Lecture: {{ lecture_id }}</h3>
                    <p><em>[insert num] participants online</em></p>

                    <ul id="myBunnies" class="bunnyList"></ul>
                </div>
                
                <button class="btn-block btn btn-large" onclick="edit.newBunny()">Add New Note</button>
                <ul id="otherBunnies" class="row bunnyList"></ul>
                <bunny-list></bunny-list>
            </div>
        </section>
    </div>
    <!-- Scripts here. Don't remove this ↓ -->
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script src="/bunny-editor.js"></script>
    <script src="/bunny-auto.js"></script>
    <script>
        window.identifiers = {
            document: {{document_id}},
            lecture: "{{lecture_id}}"
        };
        console.log(identifiers);
    </script>
    <script type="application/javascript">
        var channel = new goog.appengine.Channel('{{streamToken}}');
        var bunnies = {}; var users = {};
        var edit; var main = this;

        $(window).unload(function () {
            $.ajax({
                type: 'POST',
                url: '/api/disconnect',
                async: false,
                data: {stream_token: "{{streamToken}}"}
            });
        });

        var ts = new Date().getTime();
        var myCreator = '{{user_id}}';
        $.getJSON("/api/getbunnies?document_id=" + identifiers.document, function (data) {
            console.log(data);
            var count = 0;
            for (each in data) {
                var bunny = {
                    id: each,
                    body: data[each].note,
                    head: data[each].title
                };
                main.bunnies[each] = bunny;
            }
            console.log(window.bunnies);

            $(function () {
                edit = new editor(bunnies, "#myBunnies", "#otherBunnies", myCreator);
                edit.start();
                
                var streamToken = '{{streamToken}}';
                var socket = channel.open();
                socket.onopen = function () {
                    console.log("Connection opened");
                };
                socket.onmessage = function (message) {
                    if(!("cmd" in message))return;
                    switch(message.cmd){
                        case "updateBunny":
                            if(!message.payload.id in bunnies)break;
                            bunnies[message.payload.id] = message.payload;
                            edit.update(message.payload);
                            break;
                        case "newBunny":
                            bunnies[message.payload.id] = message.payload;
                            break;
                        case "removeBunny":
                            bunnies[message.id] = null;
                            edit.deleteBunnyByID(message.id);
                            break;
                            
                        case "newUser":
                            users[message.payload.id] = message.payload;
                            break;
                        case "removeUser":
                            users[message.id] = null;
                            break;
                    }
                };
            });
        });

        $("body").on("updated", ".bunny", function (e, obj) {
            console.log("Edited");
            var bunnyData = edit.dataFromDOMBunny(e.target);
            $.post('/api/update_bunny',{title: bunnyData.title, note: bunnyData.note, bunny_id: bunnyData.id},function(){
                console.log("EDITTED");
            });
        });

        $("body").on("created", ".bunny", function (e, obj) {
            console.log("Created");
            var bunny = $(e.target);
            $.post('/api/add_bunny',{document_id: identifiers.document, lecture_id: identifiers.lecture, title:"", note:"Empty"},function(data){
                bunny.attr("id","bunny-"+data);
                bunny.attr("bunny-id",data);
                edit.data[data] = {id:data,timestamp:new Date().getTime(),note:"",title:""};
            });
        });
        
        $("body").on("keydown","textarea",function(e){
            
            var suggestions = suggest(main.bunnies,e.target.value,[]);
            console.log(suggestions);
        });

        // PUBLISHED EVENTS
        //   edited: Runs when the content of a bunny changes
        //    added: Runs when a new bunny is added to either list
        //  created: Runs when a new bunny is created in either list
        //  removed: Runs when a bunny is deleted
        //   pulled: Runs when another user's bunny is dragged in
    </script>


{% endblock %}
